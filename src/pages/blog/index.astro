---
import MainLayout from "../../layouts/MainLayout.astro";
import Card from "../../components/ui/Card.astro";
import videoData from "../../data/videoData.json";
import { getCollection } from 'astro:content';

// è·å–æœç´¢å‚æ•°
const searchQuery = Astro.url.searchParams.get('search') || '';
const pageParam = Astro.url.searchParams.get('page');
const page = pageParam ? parseInt(pageParam) : 1;
const itemsPerPage = 12; // åˆå§‹åŠ è½½12ç¯‡æ–‡ç« 

// è°ƒè¯• URL å‚æ•°
console.log('ğŸŒ URL å‚æ•°è°ƒè¯•:');
console.log('   å®Œæ•´ URL:', Astro.url.toString());
console.log('   åŸå§‹ page å‚æ•°:', pageParam);
console.log('   è§£æåçš„ page:', page);
console.log('   æœç´¢å‚æ•°:', searchQuery);



// è·å–æ‰€æœ‰ Markdown æ–‡ç« 
const markdownArticles = await getCollection('blog');

// å¤„ç† Markdown æ–‡ç« æ•°æ®
const allArticles = markdownArticles.map(article => ({
  ...article,
  isMarkdown: true,
  title: article.data.title,
  summary: article.data.summary,
  author: article.data.author,
  pubDate: article.data.pubDate,
  tags: article.data.tags,
  type: article.data.type,
  featured: article.data.featured || false,
  link: `/blog/${article.slug}`,
  contentType: 'markdown',
  isExternal: false,
  description: article.data.summary
})).sort((a, b) => new Date(b.pubDate).valueOf() - new Date(a.pubDate).valueOf());



// å¤„ç†è§†é¢‘æ•°æ®ï¼Œæ·»åŠ ç±»å‹æ ‡è¯†
const allVideos = videoData.featuredVideos.map(video => ({
  ...video,
  type: 'Video',
  contentType: 'youtube',
  pubDate: video.publishDate,
  author: 'Spark Liang',
  featured: false,
  link: `https://www.youtube.com/watch?v=${video.videoId}`,
  isExternal: true,
  summary: video.description
}));

// åˆå¹¶æ‰€æœ‰å†…å®¹ï¼ˆæ–‡ç« å’Œè§†é¢‘ï¼‰
const allContent = [...allArticles, ...allVideos].sort((a, b) => {
  // æŒ‰æ—¥æœŸæ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
  const dateA = a.pubDate ? new Date(a.pubDate).valueOf() : 0;
  const dateB = b.pubDate ? new Date(b.pubDate).valueOf() : 0;
  return dateB - dateA;
});

// æœç´¢è¿‡æ»¤
let filteredContent;
if (searchQuery && searchQuery.trim() !== '') {
  filteredContent = allContent.filter(item => {
    const query = searchQuery.toLowerCase().trim();
    const titleMatch = item.title.toLowerCase().includes(query);
    const summaryMatch = item.summary && item.summary.toLowerCase().includes(query);
    const descriptionMatch = item.description && item.description.toLowerCase().includes(query);
    const tagMatch = item.tags && item.tags.some((tag: string) => tag.toLowerCase().includes(query));
    
    return titleMatch || summaryMatch || descriptionMatch || tagMatch;
  });
} else {
  filteredContent = allContent;
}

// åˆ†é¡µ
const totalPages = Math.ceil(filteredContent.length / itemsPerPage);
const startIndex = (page - 1) * itemsPerPage;
const endIndex = startIndex + itemsPerPage;
const paginatedContent = filteredContent.slice(startIndex, endIndex);

// è°ƒè¯•åˆ†é¡µä¿¡æ¯
console.log('ğŸ“„ åˆ†é¡µè°ƒè¯•ä¿¡æ¯:');
console.log('   æ€»å†…å®¹æ•°é‡:', filteredContent.length);
console.log('   æ¯é¡µæ˜¾ç¤ºæ•°é‡:', itemsPerPage);
console.log('   æ€»é¡µæ•°:', totalPages);
console.log('   å½“å‰é¡µ:', page);
console.log('   èµ·å§‹ç´¢å¼•:', startIndex);
console.log('   ç»“æŸç´¢å¼•:', endIndex);
console.log('   å½“å‰é¡µå†…å®¹æ•°é‡:', paginatedContent.length);
console.log('   å½“å‰é¡µå†…å®¹:', paginatedContent.map(item => item.title));
console.log('   æ‰€æœ‰å†…å®¹æ ‡é¢˜:', allContent.map(item => item.title));
console.log('   è¿‡æ»¤åå†…å®¹æ ‡é¢˜:', filteredContent.map(item => item.title));

// è·å–æ‰€æœ‰æ ‡ç­¾ç”¨äºç­›é€‰
const allTags = [...new Set(allContent.flatMap(item => item.tags || []))];


---

<MainLayout title="å†…å®¹ä¸­å¿ƒ - Sparkå®˜æ–¹ç½‘ç«™">
	<main class="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50">
		<!-- é¡µé¢æ ‡é¢˜å’Œæœç´¢åŒºåŸŸ -->
		<section class="py-12 px-4 mx-auto max-w-screen-xl">
			<div class="mx-auto max-w-screen-sm text-center lg:mb-16 mb-8">
				<h1 class="mb-4 text-4xl lg:text-5xl tracking-tight font-extrabold text-primary">ğŸ“š å†…å®¹ä¸­å¿ƒ</h1>
				<p class="font-light sm:text-xl text-dark">æ¢ç´¢æˆ‘ä»¬çš„ç²¾é€‰æ–‡ç« å’Œè§†é¢‘ï¼Œè·å–æ·±åº¦è§è§£å’Œå®ç”¨çŸ¥è¯†</p>
			</div>

			<!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
			<div class="mb-8">
				<form method="GET" action="/blog" class="flex flex-col sm:flex-row gap-4 max-w-2xl mx-auto">
					<div class="flex-1 relative">
						<input 
							type="text" 
							name="search" 
							value={searchQuery}
							placeholder="æœç´¢æ–‡ç« ã€è§†é¢‘æ ‡é¢˜ã€å†…å®¹æˆ–æ ‡ç­¾..." 
							class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent focus:border-transparent"
						>
						<svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
						</svg>
					</div>
					<button type="submit" class="px-6 py-3 bg-accent hover:bg-accent/90 text-white font-medium rounded-xl transition-colors duration-200">
						æœç´¢
					</button>
					{searchQuery && (
						<a href="/blog" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-dark font-medium rounded-xl transition-colors duration-200">
							æ¸…é™¤
						</a>
					)}
				</form>
			</div>

			<!-- æœç´¢ç»“æœç»Ÿè®¡ -->
			{searchQuery && (
				<div class="text-center mb-6">
					<div class="bg-accent/10 border border-accent/20 rounded-xl p-4 mb-4">
						<p class="text-dark">
							ğŸ” æœç´¢ "<span class="font-bold text-accent">{searchQuery}</span>" 
							æ‰¾åˆ° <span class="font-bold text-accent">{filteredContent.length}</span> ä¸ªç»“æœ
							{filteredContent.length !== allContent.length && (
								<span class="text-gray-500">ï¼ˆå…± {allContent.length} ä¸ªå†…å®¹ï¼‰</span>
							)}
						</p>
						{filteredContent.length === 0 && (
							<p class="text-gray-500 mt-2">
								æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯
							</p>
						)}
					</div>
				</div>
			)}

			<!-- æ ‡ç­¾ç­›é€‰ -->
			<div class="mb-8">
				<div class="flex flex-wrap gap-2 justify-center">
					{allTags.slice(0, 10).map((tag: string) => (
						<a 
							href={`/blog?search=${encodeURIComponent(tag)}`}
							class="px-3 py-1 bg-white hover:bg-accent hover:text-white text-dark text-sm font-medium rounded-full border border-gray-200 transition-colors duration-200"
						>
							{tag}
						</a>
					))}
				</div>
			</div>
		</section>

		<!-- å†…å®¹ç½‘æ ¼ -->
		<section class="px-4 mx-auto max-w-screen-xl pb-12">
			{filteredContent.length > 0 ? (
				<div id="content-grid" class="grid gap-8 lg:grid-cols-2 xl:grid-cols-3">
					{paginatedContent.map(item => (
						<Card isUnderline={true}>
							<article class="p-6 bg-white rounded-[45px] hover:shadow-lg transition-all duration-300 hover:scale-105">
								<div class="flex items-center justify-between mb-4">
									<span class={`text-white text-xs font-medium px-3 py-1 rounded-full ${
										item.contentType === 'youtube' 
											? 'bg-red-600' 
											: 'bg-accent'
									}`}>
										{item.type} â€¢ {item.contentType === 'youtube' ? 'YouTube' : item.contentType === 'markdown' ? 'Markdown' : 'äº¤äº’å¼'}
									</span>
									{item.featured && (
										<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-1 rounded-full">
											æ¨è
										</span>
									)}
								</div>
								
								<h3 class="mb-3 text-xl font-bold tracking-tight text-primary hover:text-accent transition-colors">
									<a href={item.link} target={item.isExternal ? "_blank" : undefined} rel={item.isExternal ? "noopener noreferrer" : undefined}>{item.title}</a>
								</h3>
								
								<p class="mb-4 text-dark line-clamp-3">{item.summary || item.description}</p>
								
								<div class="flex flex-wrap gap-2 mb-4">
									{(item.tags || []).slice(0, 3).map((tag: string) => (
										<span class="bg-gray text-primary text-xs font-medium px-2 py-1 rounded">
											{tag}
										</span>
									))}
								</div>
								
								<div class="flex items-center justify-between">
									<div class="flex items-center space-x-3">
										<div class="w-8 h-8 rounded-full bg-accent flex items-center justify-center">
											<span class="text-dark text-sm font-bold">{item.author.charAt(0)}</span>
										</div>
										<div class="text-sm">
											<p class="text-primary font-medium">{item.author}</p>
											<p class="text-dark">{new Date(item.pubDate).toLocaleDateString('zh-CN')}</p>
										</div>
									</div>
									<a href={item.link} target={item.isExternal ? "_blank" : undefined} rel={item.isExternal ? "noopener noreferrer" : undefined} class="inline-flex items-center font-medium text-primary hover:text-accent transition-colors">
										{item.contentType === 'youtube' ? 'è§‚çœ‹è§†é¢‘' : 'é˜…è¯»å…¨æ–‡'}
										<svg class="ml-2 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
											<path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
										</svg>
									</a>
								</div>
							</article>
						</Card>
					))}
				</div>
			) : (
				<div class="text-center py-12">
					<div class="mb-4">
						<svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
						</svg>
					</div>
					<h3 class="text-lg font-medium text-gray-900 mb-2">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹</h3>
					<p class="text-gray-500 mb-4">å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯æœç´¢ï¼Œæˆ–è€…æµè§ˆæ‰€æœ‰å†…å®¹</p>
					<a href="/blog" class="inline-flex items-center px-4 py-2 bg-accent hover:bg-accent/90 text-white font-medium rounded-lg transition-colors duration-200">
						æŸ¥çœ‹æ‰€æœ‰å†…å®¹
					</a>
				</div>
			)}

			<!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
			{page < totalPages && (
				<div id="load-more-container" class="mt-12 flex justify-center">
					<button id="load-more" class="px-8 py-4 bg-accent hover:bg-accent/90 text-white font-bold rounded-xl transition-all duration-300 transform hover:scale-105">
						åŠ è½½æ›´å¤š
					</button>
				</div>
			)}
		</section>
	</main>

</MainLayout> 

<script define:vars={{ totalPages, initialPage: page }}>
	document.addEventListener('DOMContentLoaded', () => {
	  const loadMoreButton = document.getElementById('load-more');
	  const contentGrid = document.getElementById('content-grid');
	  let currentPage = initialPage;

	  if (currentPage >= totalPages) {
		if (loadMoreButton) loadMoreButton.style.display = 'none';
	  }

	  if (loadMoreButton) {
		loadMoreButton.addEventListener('click', async () => {
		  if (currentPage >= totalPages) return;

		  currentPage++;
		  loadMoreButton.textContent = 'æ­£åœ¨åŠ è½½...';
		  loadMoreButton.disabled = true;

		  try {
			const response = await fetch(`/api/posts.json?page=${currentPage}`);
			const data = await response.json();

			data.posts.forEach(item => {
			  const card = document.createElement('div');
			  card.innerHTML = `
				<article class="p-6 bg-white rounded-[45px] hover:shadow-lg transition-all duration-300 hover:scale-105">
					<div class="flex items-center justify-between mb-4">
						<span class="text-white text-xs font-medium px-3 py-1 rounded-full ${item.type === 'Video' ? 'bg-red-600' : 'bg-accent'}">
							${item.type} â€¢ ${item.type === 'Video' ? 'YouTube' : 'Markdown'}
						</span>
					</div>
					<h3 class="mb-3 text-xl font-bold tracking-tight text-primary hover:text-accent transition-colors">
						<a href="${item.url}" target="${item.url.startsWith('http') ? '_blank' : '_self'}">${item.title}</a>
					</h3>
					<p class="mb-4 text-dark line-clamp-3">${item.description}</p>
					<div class="flex items-center justify-between">
						<div class="flex items-center space-x-3">
							<div class="w-8 h-8 rounded-full bg-accent flex items-center justify-center">
								<span class="text-dark text-sm font-bold">${item.author.charAt(0)}</span>
							</div>
							<div class="text-sm">
								<p class="text-primary font-medium">${item.author}</p>
								<p class="text-dark">${new Date(item.pubDate).toLocaleDateString('zh-CN')}</p>
							</div>
						</div>
						<a href="${item.url}" target="${item.url.startsWith('http') ? '_blank' : '_self'}" class="inline-flex items-center font-medium text-primary hover:text-accent transition-colors">
							${item.type === 'Video' ? 'è§‚çœ‹è§†é¢‘' : 'é˜…è¯»å…¨æ–‡'}
							<svg class="ml-2 w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
						</a>
					</div>
				</article>
			  `;
			  contentGrid.appendChild(card.firstElementChild);
			});

			if (currentPage >= data.totalPages) {
			  loadMoreButton.style.display = 'none';
			} else {
			  loadMoreButton.textContent = 'æŸ¥çœ‹æ›´å¤š';
			  loadMoreButton.disabled = false;
			}
		  } catch (error) {
			console.error('åŠ è½½æ›´å¤šå†…å®¹å¤±è´¥:', error);
			loadMoreButton.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
			loadMoreButton.disabled = false;
		  }
		});
	  }
	});
  </script>